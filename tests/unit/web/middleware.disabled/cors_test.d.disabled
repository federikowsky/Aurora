/**
 * CORS Middleware Tests
 *
 * TDD: Aurora CORS Middleware
 *
 * Features:
 * - Preflight OPTIONS handling
 * - CORS headers (Origin, Methods, Headers)
 * - Origin validation
 * - Credentials support
 */
module tests.unit.web.middleware.cors_test;

import unit_threaded;
import aurora.web.middleware.cors;
import aurora.web.middleware;
import aurora.web.context;
import aurora.http;

// ========================================
// PREFLIGHT OPTIONS TESTS
// ========================================

// Test 1: OPTIONS request returns 204
@("CORS handles OPTIONS preflight")
unittest
{
    auto config = CORSConfig();
    auto cors = new CORSMiddleware(config);
    
    Context ctx;
    HTTPRequest req;
    HTTPResponse res;
    req.method = "OPTIONS";
    req.path = "/api/users";
    ctx.request = &req;
    ctx.response = &res;
    
    bool nextCalled = false;
    void next() { nextCalled = true; }
    
    cors.handle(ctx, &next);
    
    res.statusCode.shouldEqual(204);
    nextCalled.shouldBeFalse;  // Should not call next
}

// Test 2: OPTIONS sets Allow-Origin header
@("OPTIONS sets Allow-Origin")
unittest
{
    auto config = CORSConfig();
    config.allowedOrigins = ["https://example.com"];
    auto cors = new CORSMiddleware(config);
    
    Context ctx;
    HTTPRequest req;
    HTTPResponse res;
    req.method = "OPTIONS";
    ctx.request = &req;
    ctx.response = &res;
    
    void next() { }
    
    cors.handle(ctx, &next);
    
    res.headers["Access-Control-Allow-Origin"].shouldEqual("https://example.com");
}

// Test 3: OPTIONS sets Allow-Methods header
@("OPTIONS sets Allow-Methods")
unittest
{
    auto config = CORSConfig();
    config.allowedMethods = ["GET", "POST", "PUT"];
    auto cors = new CORSMiddleware(config);
    
    Context ctx;
    HTTPRequest req;
    HTTPResponse res;
    req.method = "OPTIONS";
    ctx.request = &req;
    ctx.response = &res;
    
    void next() { }
    
    cors.handle(ctx, &next);
    
    res.headers["Access-Control-Allow-Methods"].shouldEqual("GET,POST,PUT");
}

// Test 4: OPTIONS sets Allow-Headers header
@("OPTIONS sets Allow-Headers")
unittest
{
    auto config = CORSConfig();
    config.allowedHeaders = ["Content-Type", "Authorization"];
    auto cors = new CORSMiddleware(config);
    
    Context ctx;
    HTTPRequest req;
    HTTPResponse res;
    req.method = "OPTIONS";
    ctx.request = &req;
    ctx.response = &res;
    
    void next() { }
    
    cors.handle(ctx, &next);
    
    res.headers["Access-Control-Allow-Headers"].shouldEqual("Content-Type,Authorization");
}

// Test 5: OPTIONS sets Max-Age header
@("OPTIONS sets Max-Age")
unittest
{
    auto config = CORSConfig();
    config.maxAge = 3600;
    auto cors = new CORSMiddleware(config);
    
    Context ctx;
    HTTPRequest req;
    HTTPResponse res;
    req.method = "OPTIONS";
    ctx.request = &req;
    ctx.response = &res;
    
    void next() { }
    
    cors.handle(ctx, &next);
    
    res.headers["Access-Control-Max-Age"].shouldEqual("3600");
}

// ========================================
// CORS HEADERS TESTS
// ========================================

// Test 6: Normal request sets Allow-Origin
@("normal request sets Allow-Origin")
unittest
{
    auto config = CORSConfig();
    config.allowedOrigins = ["https://example.com"];
    auto cors = new CORSMiddleware(config);
    
    Context ctx;
    HTTPRequest req;
    HTTPResponse res;
    req.method = "GET";
    req.path = "/api/users";
    ctx.request = &req;
    ctx.response = &res;
    
    void next() { }
    
    cors.handle(ctx, &next);
    
    res.headers["Access-Control-Allow-Origin"].shouldEqual("https://example.com");
}

// Test 7: Wildcard origin
@("wildcard origin allowed")
unittest
{
    auto config = CORSConfig();
    config.allowedOrigins = ["*"];
    auto cors = new CORSMiddleware(config);
    
    Context ctx;
    HTTPRequest req;
    HTTPResponse res;
    req.method = "GET";
    ctx.request = &req;
    ctx.response = &res;
    
    void next() { }
    
    cors.handle(ctx, &next);
    
    res.headers["Access-Control-Allow-Origin"].shouldEqual("*");
}

// Test 8: Credentials header
@("credentials header set when enabled")
unittest
{
    auto config = CORSConfig();
    config.allowCredentials = true;
    auto cors = new CORSMiddleware(config);
    
    Context ctx;
    HTTPRequest req;
    HTTPResponse res;
    req.method = "GET";
    ctx.request = &req;
    ctx.response = &res;
    
    void next() { }
    
    cors.handle(ctx, &next);
    
    res.headers["Access-Control-Allow-Credentials"].shouldEqual("true");
}

// Test 9: Expose headers
@("expose headers set")
unittest
{
    auto config = CORSConfig();
    config.exposedHeaders = ["X-Total-Count", "X-Page"];
    auto cors = new CORSMiddleware(config);
    
    Context ctx;
    HTTPRequest req;
    HTTPResponse res;
    req.method = "GET";
    ctx.request = &req;
    ctx.response = &res;
    
    void next() { }
    
    cors.handle(ctx, &next);
    
    res.headers["Access-Control-Expose-Headers"].shouldEqual("X-Total-Count,X-Page");
}

// Test 10: Normal request calls next
@("normal request calls next")
unittest
{
    auto config = CORSConfig();
    auto cors = new CORSMiddleware(config);
    
    Context ctx;
    HTTPRequest req;
    HTTPResponse res;
    req.method = "GET";
    ctx.request = &req;
    ctx.response = &res;
    
    bool nextCalled = false;
    void next() { nextCalled = true; }
    
    cors.handle(ctx, &next);
    
    nextCalled.shouldBeTrue;
}

// ========================================
// ORIGIN VALIDATION TESTS
// ========================================

// Test 11: Specific origin allowed
@("specific origin allowed")
unittest
{
    auto config = CORSConfig();
    config.allowedOrigins = ["https://app.example.com"];
    auto cors = new CORSMiddleware(config);
    
    Context ctx;
    HTTPRequest req;
    HTTPResponse res;
    req.method = "GET";
    req.headers["Origin"] = "https://app.example.com";
    ctx.request = &req;
    ctx.response = &res;
    
    void next() { }
    
    cors.handle(ctx, &next);
    
    res.headers["Access-Control-Allow-Origin"].shouldEqual("https://app.example.com");
}

// Test 12: Multiple origins
@("multiple origins supported")
unittest
{
    auto config = CORSConfig();
    config.allowedOrigins = ["https://app1.com", "https://app2.com"];
    auto cors = new CORSMiddleware(config);
    
    Context ctx;
    HTTPRequest req;
    HTTPResponse res;
    req.method = "GET";
    req.headers["Origin"] = "https://app2.com";
    ctx.request = &req;
    ctx.response = &res;
    
    void next() { }
    
    cors.handle(ctx, &next);
    
    // Should match the requesting origin
    res.headers["Access-Control-Allow-Origin"].shouldEqual("https://app2.com");
}

// Test 13: Origin not in allowed list
@("origin not allowed returns first")
unittest
{
    auto config = CORSConfig();
    config.allowedOrigins = ["https://allowed.com"];
    auto cors = new CORSMiddleware(config);
    
    Context ctx;
    HTTPRequest req;
    HTTPResponse res;
    req.method = "GET";
    req.headers["Origin"] = "https://notallowed.com";
    ctx.request = &req;
    ctx.response = &res;
    
    void next() { }
    
    cors.handle(ctx, &next);
    
    // Should return first allowed origin (or handle differently)
    res.headers["Access-Control-Allow-Origin"].shouldEqual("https://allowed.com");
}

// Test 14: No Origin header
@("no origin header handled")
unittest
{
    auto config = CORSConfig();
    config.allowedOrigins = ["https://example.com"];
    auto cors = new CORSMiddleware(config);
    
    Context ctx;
    HTTPRequest req;
    HTTPResponse res;
    req.method = "GET";
    // No Origin header
    ctx.request = &req;
    ctx.response = &res;
    
    void next() { }
    
    cors.handle(ctx, &next);
    
    // Should still set CORS headers
    res.headers["Access-Control-Allow-Origin"].shouldEqual("https://example.com");
}

// Test 15: Case-insensitive origin matching
@("origin matching case insensitive")
unittest
{
    auto config = CORSConfig();
    config.allowedOrigins = ["https://Example.COM"];
    auto cors = new CORSMiddleware(config);
    
    Context ctx;
    HTTPRequest req;
    HTTPResponse res;
    req.method = "GET";
    req.headers["Origin"] = "https://example.com";
    ctx.request = &req;
    ctx.response = &res;
    
    void next() { }
    
    cors.handle(ctx, &next);
    
    // Should match (case-insensitive)
    assert(res.headers["Access-Control-Allow-Origin"].length > 0);
}

// ========================================
// EDGE CASES
// ========================================

// Test 16: Empty allowed origins
@("empty allowed origins handled")
unittest
{
    auto config = CORSConfig();
    config.allowedOrigins = [];
    auto cors = new CORSMiddleware(config);
    
    Context ctx;
    HTTPRequest req;
    HTTPResponse res;
    req.method = "GET";
    ctx.request = &req;
    ctx.response = &res;
    
    void next() { }
    
    // Should not throw
    cors.handle(ctx, &next);
}

// Test 17: Empty allowed methods
@("empty allowed methods handled")
unittest
{
    auto config = CORSConfig();
    config.allowedMethods = [];
    auto cors = new CORSMiddleware(config);
    
    Context ctx;
    HTTPRequest req;
    HTTPResponse res;
    req.method = "OPTIONS";
    ctx.request = &req;
    ctx.response = &res;
    
    void next() { }
    
    // Should not throw
    cors.handle(ctx, &next);
}

// Test 18: Very long origin
@("very long origin handled")
unittest
{
    import std.array : replicate;
    
    auto config = CORSConfig();
    auto cors = new CORSMiddleware(config);
    
    Context ctx;
    HTTPRequest req;
    HTTPResponse res;
    req.method = "GET";
    req.headers["Origin"] = "https://" ~ replicate("a", 1000) ~ ".com";
    ctx.request = &req;
    ctx.response = &res;
    
    void next() { }
    
    // Should not throw
    cors.handle(ctx, &next);
}

// ========================================
// INTEGRATION TESTS
// ========================================

// Test 19: CORS with other middleware
@("CORS works with other middleware")
unittest
{
    auto config = CORSConfig();
    auto cors = new CORSMiddleware(config);
    
    Context ctx;
    HTTPRequest req;
    HTTPResponse res;
    req.method = "GET";
    ctx.request = &req;
    ctx.response = &res;
    
    bool otherMiddlewareCalled = false;
    
    void next() {
        otherMiddlewareCalled = true;
    }
    
    cors.handle(ctx, &next);
    
    otherMiddlewareCalled.shouldBeTrue;
    assert("Access-Control-Allow-Origin" in res.headers);
}

// Test 20: Default config
@("default config works")
unittest
{
    auto config = CORSConfig();
    auto cors = new CORSMiddleware(config);
    
    Context ctx;
    HTTPRequest req;
    HTTPResponse res;
    req.method = "GET";
    ctx.request = &req;
    ctx.response = &res;
    
    void next() { }
    
    cors.handle(ctx, &next);
    
    // Should have default CORS headers
    assert("Access-Control-Allow-Origin" in res.headers);
}
