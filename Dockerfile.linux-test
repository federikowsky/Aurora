# Aurora HTTP Server - Linux Test Container
# Tests multi-worker architecture with SO_REUSEPORT

FROM debian:bookworm-slim

# Install dependencies
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    python3 \
    python3-pip \
    python3-requests \
    procps \
    htop \
    xz-utils \
    gcc \
    g++ \
    libc6-dev \
    libxml2 \
    zlib1g \
    make \
    libc++1 \
    libc++-dev \
    libc++abi1 \
    libc++abi-dev \
    && rm -rf /var/lib/apt/lists/*

# Install LDC 1.38 (latest stable with shortenedMethods support by default)
# Detect architecture and download appropriate version
ENV LDC_VERSION=1.38.0
RUN ARCH=$(dpkg --print-architecture) && \
    if [ "$ARCH" = "arm64" ]; then \
        LDC_ARCH="linux-aarch64"; \
    else \
        LDC_ARCH="linux-x86_64"; \
    fi && \
    wget -q https://github.com/ldc-developers/ldc/releases/download/v${LDC_VERSION}/ldc2-${LDC_VERSION}-${LDC_ARCH}.tar.xz \
    && tar xf ldc2-${LDC_VERSION}-${LDC_ARCH}.tar.xz \
    && mv ldc2-${LDC_VERSION}-${LDC_ARCH} /opt/ldc \
    && rm ldc2-${LDC_VERSION}-${LDC_ARCH}.tar.xz

# Add LDC to PATH
ENV PATH="/opt/ldc/bin:${PATH}"

# Install dub separately (comes with LDC)
RUN ln -s /opt/ldc/bin/dub /usr/local/bin/dub || true

# Set working directory
WORKDIR /app

# Copy source code
COPY . .

# Clean and rebuild wire library for Linux
RUN cd lib/wire && rm -rf build && mkdir -p build && make lib DC=ldc2 CC=gcc CFLAGS="-O3 -fPIC -Wall"

# Clean and rebuild fastjsond library for Linux
RUN cd lib/fastjsond && rm -rf build && mkdir -p build && make lib DC=ldc2 CXX=g++ CXXFLAGS="-O3 -std=c++17 -DNDEBUG -fPIC"

# Build the project
RUN dub build --force --compiler=ldc2 || (echo "Build failed" && exit 1)

# Build the fiber test
RUN dub build --config=fiber-test --force --compiler=ldc2

# Run tests
RUN dub test --compiler=ldc2 || echo "Tests completed"

# Expose port
EXPOSE 18888

# Default command: run fiber test server
CMD ["./fiber_test"]
